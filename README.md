# Zombies
Only for myself

## 🎮 快速开始

### 项目已重构！新结构更清晰、更易维护

**查看详细结构说明**: [STRUCTURE.md](STRUCTURE.md)

### 三个运行入口：

1. **主游戏** - 完整的僵尸生存游戏
   ```bash
   cd src
   python main.py
   ```

2. **背包系统测试** - 独立的装备和背包管理界面
   ```bash
   cd src/tests
   python test_inventory.py
   ```

3. **怪物系统测试** - 怪物生成和平衡性测试
   ```bash
   cd src/tests
   python test_monsters.py
   ```

---

## 📋 游戏设计文档

战斗体系可以是这样的：

游戏开始界面只有一个按钮，开始游戏

进入游戏后是一个二维游戏，包括玩家、僵尸、道路以及不可通行的建筑。

玩家基础操作：
上下左右移动，空格回血（回复值为20%+250，冷却30s），左键射击（任意方向），右键加速奔跑（消耗20%生命，持续10s，冷却30s），esc切出背包并暂停

杀怪获得尸核，可以升级技能树，包括：
体能线，可以选择提高被动回血速度/回血技能效果/闪避/移速/转身速率
战术线，通用战术：射速/暴击率/穿透率/射程，20级可选散弹分支，增加2/4/6散弹
勘探线，特殊技能，增加装备爆率/允许精炼装备（每个装备可以重炼一次词条/重炼后必定提升词条数值）

装备：击杀僵尸随机掉落，玩家经过即可拾取，背包上限为20*40，枪械安装上限为10*20

装备品质：普通（白色，1词条，形状为随机的1-3格方块）、精良（蓝色，2词条，形状为随机的2-5格方格）、史诗（黄色，3词条，形状为随机的6~9方格）、传奇（红色，4~5词条，形状为随机的8~12方格）

装备生成规则：
普通概率：20%
精良：5%
史诗：1%
传奇：0.2%
装备的每个词条会在以下列表中随机生成，每个词条的出现概率和击杀的僵尸种类（仅三种，普通僵尸，巨人僵尸，狂犬僵尸）有关，数值基于两个变量：掉落怪物等级a、装备品质系数b
攻击力
攻击力百分比
防御力
防御力百分比
生命
生命力百分比
射速（百分比，实际作用结果为160%的当前射速+20%射速，则当前射速为基础射速的180%）
暴击率
暴击伤害（基础为5%暴击率，150%暴击伤害）
穿透率（稀有属性）
射程
移速
吸血
回血速度
回血技能效果


背包规则如下：

基础设定
掉落物： 均为强化模组。
核心枪械： 玩家仅有一把，无换弹机制。
模组空间：
强化模组空间（已装备）：10 * 20 网格区域。
背包空间（未安装）： 20 * 40 网格区域。
装备机制： 
模组形状类似俄罗斯方块，只要在强化模组空间内且互不重叠，即视为装备生效。

模组
模组的品质直接决定了其词条数量 (N)、方格大小 (c) 范围和数值乘数 (b)。高品质对低品质具有压倒性优势。
品质,词条数量 (N),方格大小 (c) 范围,品质系数 (b),掉落概率 (P)
普通,1,1−3,1.0,20.0%
精良,2,4−6,1.25,5.0%
史诗,3,7−9,1.5,1.0%
传奇,4−5,10−12,2.0,0.2%

形状定义模组形状在c设定的方格大小范围内随机生成。所有方块必须是连通的。
词条的最终数值由品质系数 (b)、方格大小 (c) 和掉落怪物等级 (a) 三者共同决定。
最终词条数值 = (词条基础数值 * 品质系数  b) * (1 + 方格大小  c * 空间成长因子) * (1 + 怪物等级  a * 等级成长因子)

词缀分为通用和稀有两类。稀有词缀提供更强大的机制效果，但掉落权重较低。
类别,词缀名称示例,稀有度,战略作用
通用,攻击力、防御力、生命、生命力百分比等,高,提供基础数值堆叠，保证角色基础强度。
稀有,暴击率、暴击伤害、,中,核心 Build 机制，掉落权重低于通用词缀。
枪械强化,射速、穿透率、射程,低,改变枪械手感的关键属性。

僵尸名称,僵尸类型,掉落倾向（增加权重）
游魂,普通型,通用词缀 (攻击力、生命值等)
铁桶,防御型,生存词缀 (防御力百分比、回血速度、生命百分比)
食尸鬼,进攻型,输出/速度稀有词缀 (射速%、暴击率、移速%)

精炼级别,名称,效果
一级,Reroll All,重新随机生成该模组上的所有词条（数量 N 和方格大小 c 不变）。
二级,Lock 1-2,允许玩家保留最多两个指定的词条，然后重新随机生成其余的词条。

伤害减免百分比 = 护甲值/（护甲值 + 难度常数 * 100）



# 怪物攻击系统实现说明

## 已实现功能

### 1. 三种怪物的攻击机制

#### 游荡者 (Wanderer)
- **攻击方式**: 近战撞击
- **攻击范围**: 50像素
- **攻击冷却**: 1.5秒
- **攻击动画**: 撞击玩家后，以200px/s的速度后退50像素（硬直状态）
- **特殊机制**: 
  - 团结光环：附近每有一个游荡者（200px范围内），攻击力提升10%
  - 后退时会被墙壁阻挡，碰到墙壁立即停止后退

#### 铁桶 (Bucket)
- **攻击方式**: AoE圆环攻击
- **攻击范围**: 200像素半径
- **攻击冷却**: 2.5秒
- **攻击动画**: 从自身位置发射圆环，在2.5秒内扩散到200px半径，到达最大范围后消失
- **特殊机制**:
  - 圆环粗细为2px，颜色与怪物本体相同（灰色/橙色）
  - 只有当玩家在200px范围内时才会触发攻击
  - 尸爆：死亡0.5秒后，本体膨胀到300px半径，造成最大生命值5%的伤害

#### 食尸鬼 (Ghoul)
- **攻击方式**: 快速近战撕咬
- **攻击范围**: 30像素
- **攻击冷却**: 1.0秒
- **攻击动画**: 撞击玩家后，以200px/s的速度后退30像素（硬直状态）
- **特殊机制**:
  - 迅扑：当玩家在300-500px范围内时触发，0.5秒内加速到3倍移速，保持直到首次攻击命中
  - 10%闪避率（暂未实现）
  - 后退时会被墙壁阻挡

### 2. 伤害计算系统

#### 怪物对玩家的伤害
```
实际伤害 = 怪物基础伤害 × (1 - 玩家护甲减伤)
护甲减伤 DR = 玩家护甲 / (玩家护甲 + 100)
```

#### 光环效果
- **游荡者团结光环**: 200px范围内，每有一个游荡者，自身攻击力+10%（可叠加）
- **铁桶护甲光环**: 被动效果，暂未在攻击中体现
- **食尸鬼吸血光环**: 被动效果，暂未在攻击中体现

### 3. 攻击状态机

每个怪物有三种状态：
- `idle`: 空闲状态，可以移动和攻击
- `attacking`: 攻击中（铁桶专用，圆环扩散期间）
- `knockback`: 后退硬直（游荡者和食尸鬼专用）

### 4. 视觉效果

#### 铁桶圆环
- 从怪物中心扩散的圆环
- 2px粗细
- 在攻击冷却时间内从0扩散到最大范围

#### 尸爆效果
- 延迟阶段：尸体位置每0.25秒闪烁黄色警告圈
- 爆炸阶段：红橙色圆圈从0膨胀到最大范围（0.5秒）
- 半透明效果，逐渐消失

### 5. Game Over 系统

#### 触发条件
- 玩家生命值降到0

#### UI显示
- 半透明灰色遮罩覆盖整个屏幕
- 显示"GAME OVER"大标题（红色）
- 显示存活天数
- 两个按钮：
  - "从头开始"（绿色）
  - "回到上一天"（蓝色）
- 当前两个按钮功能相同，都是重新开始游戏

### 6. 日志输出

游戏会输出以下日志信息：
- `[怪物名称] 发动了攻击！`
- `[怪物名称] 发动了迅扑！`
- `[怪物名称] 迅扑攻击命中，结束迅扑状态`
- `[怪物名称] 后退时撞到墙壁`
- `玩家受到 [X] 点伤害（原始伤害：[Y]，护甲减免：[Z]%）- 来源：[怪物名称]`
- `当前生命值：[X] / [Y]`
- `[怪物名称] 死亡，将在0.5秒后爆炸`
- `[怪物名称] 的尸体爆炸了！`
- `玩家死亡！`

## 配置参数

所有攻击相关参数在 `src/config.py` 中定义：

```python
# 攻击冷却时间（秒）
MONSTER_ATTACK_COOLDOWN = {
    "Wanderer": 1.5,
    "Bucket": 2.5,
    "Ghoul": 1.0
}

# 攻击范围（像素）
MONSTER_ATTACK_RANGE = {
    "Wanderer": 50,
    "Bucket": 200,
    "Ghoul": 30
}

# 后退参数
MONSTER_KNOCKBACK_SPEED = 200  # 后退速度 px/s

# 食尸鬼迅扑参数
GHOUL_DASH_MIN_RANGE = 300
GHOUL_DASH_MAX_RANGE = 500
GHOUL_DASH_SPEED_MULT = 3.0  # 速度倍数
GHOUL_DASH_ACCEL_TIME = 0.5  # 加速到最高速的时间

# 铁桶圆环参数
BUCKET_RING_THICKNESS = 2  # 圆环粗细

# 尸爆参数
CORPSE_EXPLOSION_DELAY = 0.5  # 尸爆延迟（秒）
CORPSE_EXPLOSION_RANGE = 300  # 尸爆范围（像素）
```

## 暂未实现的功能

以下功能在设计中但暂未实现：

1. **精英怪物技能**
   - 游荡者：召唤小怪
   - 铁桶：烈爆（增强尸爆）、巨人（生命值越低攻防越高）
   - 食尸鬼：暴击、飞天（远程攻击）

2. **技能等级解锁**
   - 当前所有技能（除精英技能外）默认解锁

3. **食尸鬼闪避**
   - 10%概率闪避玩家攻击

4. **护甲光环和吸血光环**
   - 被动效果已在设计中但未完全实现

## 测试建议

1. 运行 `python src/tests/test_game.py` 启动游戏
2. 观察不同怪物的攻击方式
3. 测试后退硬直遇墙的效果
4. 测试食尸鬼迅扑的触发和结束
5. 测试铁桶圆环扩散效果
6. 让铁桶死亡，观察尸爆效果
7. 让玩家死亡，观察Game Over界面

## 已知问题

1. 光环效果计算可能不够精确，需要在大量怪物时测试性能
2. 尸爆的伤害判定可能需要优化，避免重复伤害
3. Game Over后的"回到上一天"功能需要实现存档系统
